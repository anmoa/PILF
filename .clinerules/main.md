# PILF: Predictive Integrity Learning Framework

## 1. 框架核心组件

当前框架中可组合的模块，这定义了我们实验的“基因库”。

- **模型架构**
  - `ViT`: 基线架构。标准的 Vision Transformer。
  - `LinearMoE`: 线性门控 MoE。门控机制为 `nn.Linear`。
  - `GaussMoE`: 高斯路由 MoE。核心特征是使用高斯分布进行专家路由。
  - `MemoryGaussianMoE`: 记忆高斯路由 MoE。通过在反向传播中利用历史路由分布来增强模型的能力。
- **前向路由策略**
  - `Linear Top-K`: 简单的线性层 + Top-K。
  - `Gaussian Top-K`: 基于输入与专家高斯分布的匹配度进行路由。
- **反向更新策略**
  - `Standard`: 全量更新。对所有参数执行梯度下降，`Dense`专属策略。
  - `Selective`: 仅对 `Top_k` 进行梯度下降，`Standard MoE`专属策略。
  - `SMK`: Surprise Min-K，对所有参数执行梯度下降，仅更新 `Surprise` 最低的 `min_k` 个。

## 2. 工程准则

- **并行优化**：所有数据操作尽可能使用并行化的张量编程，确保一切计算均在Pytorch计算图内完成，减少通信损耗。
- **向后兼容**: 所有代码修改都应保持向后兼容性，允许旧的实验配置和脚本继续运行。
- **可复现性**: 实验的超参数应通过配置文件或命令行参数指定，而不是硬编码在脚本中。所有参数都需要显式定义在配置文件等，不准引入隐式默认行为。
- **代码风格**: 代码必须简洁、自解释，移除所有不必要的注释。如果必须要保留一定的注释，则使用英文注释。如果有中文注释，在进行编辑的时候要清理或翻译。
- **环境管理**: **必须**使用 `uv` 管理独立的虚拟环境，并通过 `uv add` 命令将所有依赖项添加到 `pyproject.toml`。
- **纯函数原则**: 所有数据处理函数都应为纯函数。
- **类型安全**: 所有新代码都必须有完整的类型标注，并能通过 `ruff check --select I --fix` 的严格检查。
- **安全检查**: 在进行了 10 次文件编辑后，**必须**同时运行 `ruff check . --fix` 和 `mypy .` 来进行一次全面的静态类型检查，以确保代码库的健壮性。
- **事项记录**：在安全检查通过后，更新`process.md`。
- **宣布任务完成**：确保 `process.md` 中已经没有待办任务后，宣布任务完成。

## 3. 设计规范

### 3.1 数据粒度层级

为了在整个框架内保持概念一致性，我们定义以下数据粒度层级：

- **Token (令牌)**: 最低级别的表征单元。在 `VisionTransformer` 中，这对应一个**图像块 (patch)** 的嵌入向量。
- **Subject / Sample (主体/样本)**: 一个完整的、有意义的输入单元，由多个 `Token` 组成。在我们的场景中，这对应一张**完整的图像**。
- **Batch (批次)**: 用于单次梯度计算的 `Subject` 集合。是 `Step` 的处理对象。
- **Step (步骤)**: 一次前向与后向传播，处理一个批次的数据。对应一次优化器 `step()`。
- **Epoch (周期)**: 对整个训练数据集的一次完整遍历。由多个 `Step` 组成。
- **Task（任务）**：一组数据集，需要经过多个Epoch进行训练。

### 3.2 可视化设计

每个训练周期 (`Epoch`) 结束后，系统必须生成两张核心的可视化图表，以全面评估模型状态。所有图表都应对不同的task使用不同的颜色。无论是否用于绘制图表，tensor logs总应记录所有的标量。

1. **全局核心指标图 (`core_metrics.png`)**:
    - **目的**: 监控模型训练过程中的核心健康指标。
    - **适用范围**: 所有训练模式。
    - **内容**: 包含 `Loss`, `Accuracy`, `PI Score`, `Surprise`, `Tau` 五个指标随 `global_step` 变化的曲线图。

2. **专家激活仪表盘 (`expert_dashboard.png`)**:
    - **目的**: 深入分析混合专家（MoE）模型的内部工作模式。
    - **适用范围**: 所有 MoE 模型。
    - **内容**: 必须包含两组核心视图：
        - **路由决策视图**: 通过散点图和热力图展示哪些专家被 `top_k` 路由策略选中。
        - **参数更新视图**: 如果使用 `SMK` 策略，则通过散点图和热力图展示哪些专家的梯度最终被用于更新权重。
